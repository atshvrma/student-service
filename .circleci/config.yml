jobs: 
  build: 
    machine: true
    steps: 
      -
        run: 
          name: "git clone private project"
          command: |
              cd ~
              git clone git@github.com:atshvrma/student-service.git
              cd student-service
              mvn -DskipTests clean install
      - checkout
      - 
        run: 
          name: "maven build"
          command: "mvn -DskipTests clean install dependency:resolve-plugins dependency:go-offline"
      - 
        run: 
          name: "docker build"
          command : "docker build -t $CIRCLE_PROJECT_REPONAME -f Dockerfile ./"
      - run:
          name: Install awscli
          command: |
            python3 -m venv venv
            . venv/bin/activate
            pip install -r requirements.txt
      -
        run:
          command: |
              docker build -t 846069253880.dkr.ecr.us-east-1.amazonaws.com/my-app:latest -t 846069253880.dkr.ecr.us-east-1.amazonaws.com/my-app:$CIRCLE_SHA1 ."
              docker push 846069253880.dkr.ecr.us-east-1.amazonaws.com/my-app:$CIRCLE_SHA1


          # docker push 846069253880.dkr.ecr.us-west-2.amazonaws.com/studentservicerepo:$CIRCLE_SHA1"
          name: "docker push"

    working_directory: ~/build
version: 2
workflows: 
  version: 2
  build_and_deploy: 
    jobs: 
      - build
