jobs: 
  build: 
    machine: true
    steps: 
      -
        run: 
          name: "git clone private project"
          command: |
              cd ~
              git clone git@github.com:atshvrma/student-service.git
              cd student-service
              mvn -DskipTests clean install
      - checkout
      - 
        run: 
          name: "maven build"
          command: "mvn -DskipTests clean install dependency:resolve-plugins dependency:go-offline"
      - run:
          name: install aws
          command: |
            sudo apt-get install python-dev libffi-dev libssl-dev
            pip install --upgrade ndg-httpsclient 
            curl "https://s3.amazonaws.com/aws-cli/awscli-bundle.zip" -o "awscli-bundle.zip"
            unzip awscli-bundle.zip
            sudo ./awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws
            
            eval $(aws ecr get-login --region us-east-2 | sed 's|https://||') 

      -
        run:
          name: "docker push"
          command: |
              docker build -t $AWS_ACCOUNT_ID.dkr.ecr.us-east-2.amazonaws.com/student-service-repo:latest -t $AWS_ACCOUNT_ID.dkr.ecr.us-east-2.amazonaws.com/student-service-repo ./
              docker push $AWS_ACCOUNT_ID.dkr.ecr.us-east-2.amazonaws.com/student-service-repo
              
    working_directory: ~/build
version: 2
workflows: 
  version: 2
  build_and_deploy: 
    jobs: 
      - build
