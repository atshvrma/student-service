jobs: 
  build: 
    machine: true
    steps: 
      -
        run: 
          name: "git clone private project"
          command: |
              cd ~
              git clone git@github.com:atshvrma/student-service.git
              cd student-service
              mvn -DskipTests clean install
      - checkout
      - 
        run: 
          name: "maven build"
          command: "mvn -DskipTests clean install dependency:resolve-plugins dependency:go-offline"
      - 
        run: 
          name: "login into aws"
          command: "eval $(aws ecr get-login --registry-ids $AWS_ACCOUNT_ID --no-include-email --region $AWS_REGION | sed 's|https://||')"
      - run:
          name: install aws
          command: |
            sudo apt-get install python-dev libffi-dev libssl-dev
            pip install --upgrade ndg-httpsclient 
            curl "https://s3.amazonaws.com/aws-cli/awscli-bundle.zip" -o "awscli-bundle.zip"
            unzip awscli-bundle.zip
            sudo ./awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws

      -
        run:
          name: "docker push"
          command: |
              docker build -t $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/student-service-repo:latest_1 ./
              docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/student-service-repo
      -
        run:
          name:"docker run "
          command: |
              docker run -d -p 8080:8080 --name student-service $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/student-service-repo
              
    working_directory: ~/build
  deploy-dev: 
    machine: true
    steps: 
      - 
        checkout: 
          path: $CIRCLE_PROJECT_REPONAME
      - 
        run: 
          command: |
              
              kubectl apply -f /home/circleci/build/$CIRCLE_PROJECT_REPONAME/kube/dev/deployment/$CIRCLE_PROJECT_REPONAME.yml
              kubectl set image deployment/$CIRCLE_PROJECT_REPONAME gd-deploy-image=gcr.io/${GCLOUD_PROJECT_ID}/$CIRCLE_PROJECT_REPONAME:$CIRCLE_SHA1
              kubectl rollout status deployment/$CIRCLE_PROJECT_REPONAME
          name: "Deploy to Dev"
          shell: /bin/bash
    working_directory: ~/build


version: 2
workflows: 
  version: 2
  build_and_deploy: 
    jobs: 
      - build
      - 
        deploy-dev-approval: 
          requires: 
            - build
          type: approval
      - 
        deploy-dev: 
          requires: 
            - deploy-dev-approval