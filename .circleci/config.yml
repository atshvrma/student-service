jobs: 
  build: 
    machine: true
    steps: 
      -
        run: 
          name: "git clone private project"
          command: |
              cd ~
              git clone git@github.com:atshvrma/student-service.git
              cd student-service
              mvn -DskipTests clean install
      - checkout
      - 
        run: 
          name: "maven build"
          command: "mvn -DskipTests clean install dependency:resolve-plugins dependency:go-offline"
      - 
        run: 
          name: "login into aws"
          command: "eval $(aws ecr get-login --registry-ids $AWS_ACCOUNT_ID --no-include-email --region $AWS_REGION | sed 's|https://||')"
      - run:
          name: install aws
          command: |
            sudo apt-get install python-dev libffi-dev libssl-dev
            pip install --upgrade ndg-httpsclient 
            curl "https://s3.amazonaws.com/aws-cli/awscli-bundle.zip" -o "awscli-bundle.zip"
            unzip awscli-bundle.zip
            sudo ./awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws

      -
        run:
          name: "docker push"
          command: |
              docker build -t $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/student-service-repo:latest_1 ./
              docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/student-service-repo
    working_directory: ~/build




  deploy-dev: 
    machine: true
    steps:
      -
        run:
          name: "Deploy to Dev"
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
              CLUSTER='student-service-cluster'
              FAMILY='student-service'
              DOCKER_IMAGE='test-app'
              TASK='student-service-task'
              SERVICE='student-service'
              # Login to AWS
              aws configure set region $AWS_REGION
              $(aws ecr get-login)
              # Tag and push docker image
              # docker tag app $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$DOCKER_IMAGE:$CIRCLE_SHA1
              # docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$DOCKER_IMAGE:$CIRCLE_SHA1
              # Create task for docker deploy
              task_template='[
                {
                  "name": "%s",
                  "image": "%s.dkr.ecr.%s.amazonaws.com/%s:%s",
                  "essential": true,
                  "memoryReservation": 1000,
                  "portMappings": [
                    {
                      "containerPort": 8080,
                      "hostPort": 8080
                    }
                  ],
                  "environment" : [
                      { "name" : "NODE_ENV", "value" : "production" }
                  ]
                }
              ]'
              echo "$task_template"
              task_def=$(printf "$task_template" $TASK $AWS_ACCOUNT_ID $AWS_REGION $TASK $CIRCLE_SHA1)
              # Register task definition
              json=$(aws ecs register-task-definition --container-definitions "$task_def" --family "$FAMILY")
              # Grab revision # using regular bash and grep
              revision=$(echo "$json" | grep -o '"revision": [0-9]*' | grep -Eo '[0-9]+')
              # Deploy revision
              aws ecs update-service --cluster "$CLUSTER" --service "$SERVICE" --task-definition "$TASK":"$revision"
              return 0
            fi
          shell: /bin/bash
    working_directory: ~/build


version: 2
workflows: 
  version: 2
  build_and_deploy: 
    jobs: 
      - build
      - 
        deploy-dev-approval: 
          requires: 
            - build
          type: approval
      - 
        deploy-dev: 
          requires: 
            - deploy-dev-approval